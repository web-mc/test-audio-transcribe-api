# API Endpoints

Приложение предоставляет REST API с базовым путем `/api/v1`. Все endpoints описаны ниже.

## POST /api/v1/transcriptions/

**Отправка аудиофайла на транскрибацию**

### Входные данные
- **Метод**: POST
- **Content-Type**: multipart/form-data
- **Параметры**:
  - `audio_file` (UploadFile): Аудиофайл в формате MP3 или WAV, максимальный размер 25 MB.

### Валидация файла
- Допустимые расширения: .mp3, .wav
- Максимальный размер: 25 MB
- Обязательное наличие имени файла

### Выходные данные
- **Статус код**: 202 Accepted
- **Формат ответа**: JSON
- **Структура ответа**:
  ```json
  {
    "transcription_id": 123,
    "status": "STARTED"
  }
  ```
- **Описание**: Возвращает ID созданной транскрибации и статус "STARTED", указывающий на начало обработки.

### Логика работы
1. Валидируется входной файл.
2. Файл сохраняется в локальном хранилище.
3. В базе данных создается новая запись о транскрибации.
4. Запускается асинхронная задача Celery для обработки файла.
5. Возвращается ID транскрибации и начальный статус.

## GET /api/v1/transcriptions/{tid}

**Получение статуса и результата транскрибации**

### Входные данные
- **Метод**: GET
- **Путь**: /api/v1/transcriptions/{tid}
- **Параметры пути**:
  - `tid` (int): ID транскрибации.

### Выходные данные
- **Статус код**: 200 OK
- **Формат ответа**: JSON
- **Структура ответа** (пример):
  ```json
  {
    "transcription_id": 123,
    "status": "PENDING",
    "file_name": "audio.mp3"
  }
  ```
  или при завершении:
  ```json
  {
    "transcription_id": 123,
    "status": "SUCCESS",
    "file_name": "audio.mp3",
    "transcription": "Текст транскрибации..."
  }
  ```
  или при ошибке:
  ```json
  {
    "transcription_id": 123,
    "status": "FAILURE",
    "file_name": "audio.mp3",
    "error": "Описание ошибки"
  }
  ```

### Статусы транскрибации
- `PENDING`: Задача ожидает выполнения.
- `STARTED`: Задача выполняется.
- `SUCCESS`: Транскрибация завершена успешно.
- `FAILURE`: Произошла ошибка при обработке.

### Логика работы
1. Проверяется наличие записи в базе данных по указанному ID.
2. Если запись не найдена, возвращается ошибка 404.
3. Получается статус задачи из Celery.
4. Возвращается информация о транскрибации, включая статус и результат (если доступен).

## DELETE /api/v1/transcriptions/{tid}

**Удаление транскрибации**

### Входные данные
- **Метод**: DELETE
- **Путь**: /api/v1/transcriptions/{tid}
- **Параметры пути**:
  - `tid` (int): ID транскрибации.

### Выходные данные
- **Статус код**: 204 No Content (при успешном удалении)
- **Статус код**: 404 Not Found (если транскрибация не найдена)

### Логика работы
1. Ищется запись в базе данных по ID.
2. Если запись найдена, удаляется из базы данных.
3. Проверяется, есть ли другие транскрибации, использующие тот же файл.
4. Если файл больше не используется, он удаляется из хранилища.

## POST /api/v1/transcriptions/{tid}/questions

**Задавание вопроса по содержанию аудио**

### Входные данные
- **Метод**: POST
- **Путь**: /api/v1/transcriptions/{tid}/questions
- **Content-Type**: application/json
- **Параметры пути**:
  - `tid` (int): ID транскрибации.
- **Тело запроса**:
  ```json
  {
    "question": "Текст вопроса"
  }
  ```

### Выходные данные
- **Статус код**: 200 OK
- **Формат ответа**: JSON
- **Структура ответа**:
  ```json
  {
    "transcription_id": 123,
    "question": "Текст вопроса",
    "answer": "Ответ на вопрос"
  }
  ```

### Логика работы
1. Проверяется наличие транскрибации в базе данных.
2. Проверяется, что транскрибация завершена и содержит текст.
3. Отправляется запрос к AI сервису с вопросом и текстом транскрибации.
4. Возвращается ответ от AI.

См. также: [Обзор проекта](README.md), [Настройки приложения](app-settings.md)
